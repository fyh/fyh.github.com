---
layout: post
date: 2018-01-23 08:03:03 +0800
title: TCC：Atomikos的TCC
nocomments: false
---

还是预订中转机票的问题。

TCC的过程是：
1. 向系统1发起try，告知要预订A到B的机票
2. 向系统2发起try，告知要预订B到C的机票
3. 分别向1和2查询确认地址
4. 分别向1和2提交确认

如果步骤1和2执行过程中失败了，可以主动执行取消请求，或者什么都不做，1和2超时后自动取消。
如果步骤2和3执行失败了，同上。
如果步骤4执行失败了，如果是全部成功或者全部失败，同上。
如果步骤4执行失败了，如果是一部分成功，另一部分超时，需要外部干预。

如何保证4的一致性？
对4执行过程中确认失败，没有啥好的办法。
但是对超时的情况，个人认为是可以在4执行前预估请求是否会超时（比如设置请求最大时长），如果会超时就干脆失败，如果不会就都提交。
如果提交请求超时后，预计还有时间尝试下次确认，就再重试一次。由于确认是幂等的，甚至可以定时发起确认请求，直到成功，或者预计会超时为止。
代价是提高了失败的可能性，好处是提高了一致性的可能。
